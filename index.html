<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KnowMap – Plataforma de Gestão Estratégica</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Biblioteca para exportar para Excel (SheetJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Biblioteca de Ícones (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; /* slate-50 */ }
        .sidebar-link.active { background-color: #eef2ff; color: #4338ca; font-weight: 600; }
        .sidebar-link.active i { color: #4f46e5; }
        .view-content, .modal-backdrop { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Tabela Responsiva */
        @media screen and (max-width: 767px) {
            .responsive-map-table thead { display: none; }
            .responsive-map-table tr {
                display: block; margin-bottom: 1rem; border: 1px solid #e2e8f0; border-radius: 0.75rem;
                box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05); padding: 0.5rem; background-color: white;
            }
            .responsive-map-table td {
                display: flex; justify-content: space-between; align-items: center; text-align: right;
                padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9;
            }
            .responsive-map-table td:last-child { border-bottom: 0; }
            .responsive-map-table td::before { content: attr(data-label); font-weight: 600; text-align: left; color: #475569; }
        }
        
        /* Notificação Toast */
        #toast-notification {
            position: fixed; bottom: 1.5rem; right: 1.5rem; transform: translateX(200%);
            transition: transform 0.5s ease-in-out; z-index: 100;
        }
        #toast-notification.show { transform: translateX(0); }

        .tab.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
    </style>
</head>
<body class="antialiased text-slate-700">

    <div class="flex h-screen bg-slate-50">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex-col flex-shrink-0 fixed lg:relative h-full lg:flex z-40 -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="px-6 py-5 flex items-center gap-3">
                <!-- Remodeled SVG Logo -->
                <div class="w-10 h-10 flex-shrink-0">
                    <svg viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
                        <g>
                            <!-- Bulb -->
                            <circle cx="30" cy="25" r="14" fill="#FEEA9A" stroke="#2d3748" stroke-width="2"/>
                            <!-- Base -->
                            <rect x="22" y="38" width="16" height="5" fill="#2d3748" />
                            <path d="M22 43 L 38 43" stroke="#2d3748" stroke-width="2" stroke-linecap="round"/>
                            <path d="M24 45 L 36 45" stroke="#2d3748" stroke-width="2" stroke-linecap="round"/>
                            <!-- Dashed Path -->
                            <path d="M10 32 C 20 15, 40 15, 50 32" fill="none" stroke="#2d3748" stroke-width="2" stroke-dasharray="3 3" stroke-linecap="round"/>
                             <!-- Arrowhead -->
                            <polygon points="50,32 46,28 49,32 46,36" fill="#2d3748"/>
                            <!-- Rays -->
                             <line x1="30" y1="5" x2="30" y2="9" stroke="#2d3748" stroke-width="2" stroke-linecap="round"/>
                             <line x1="45" y1="15" x2="42" y2="18" stroke="#2d3748" stroke-width="2" stroke-linecap="round"/>
                             <line x1="15" y1="15" x2="18" y2="18" stroke="#2d3748" stroke-width="2" stroke-linecap="round"/>
                             <line x1="52" y1="25" x2="48" y2="25" stroke="#2d3748" stroke-width="2" stroke-linecap="round"/>
                             <line x1="8" y1="25" x2="12" y2="25" stroke="#2d3748" stroke-width="2" stroke-linecap="round"/>
                        </g>
                    </svg>
                </div>
                <h1 class="text-2xl font-extrabold text-slate-800 tracking-tighter">KnowMap</h1>
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" class="sidebar-link active flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-slate-100 transition" data-view="biblioteca"><i data-lucide="library" class="w-5 h-5"></i> Biblioteca</a>
                <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-slate-100 transition" data-view="mapa"><i data-lucide="map" class="w-5 h-5"></i> Mapa de Conhecimentos</a>
                <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-slate-100 transition" data-view="desenvolvimento"><i data-lucide="award" class="w-5 h-5"></i> Desenvolvimento</a>
                <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-slate-100 transition" data-view="monitoramento"><i data-lucide="activity" class="w-5 h-5"></i> Monitoramento</a>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <div class="flex-1 flex flex-col overflow-y-auto">
            <!-- Header -->
            <header class="sticky top-0 bg-white/80 backdrop-blur-lg border-b border-slate-200 z-30">
                <div class="mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16"><button id="menu-toggle" class="lg:hidden text-slate-600 hover:text-slate-800"><i data-lucide="menu" class="w-6 h-6"></i></button><div class="relative"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i><input id="globalSearchInput" type="text" placeholder="Buscar em toda a plataforma..." class="w-full sm:w-80 pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></div><div class="flex items-center gap-4"><div class="flex items-center gap-2 text-sm"><span id="loggedInUserName" class="font-semibold text-slate-700 hidden md:inline"></span><img src="https://placehold.co/40x40/eef2ff/4338ca?text=J" alt="Avatar do usuário" class="w-10 h-10 rounded-full border-2 border-indigo-200"></div></div></div>
                </div>
            </header>

            <!-- Conteúdo Dinâmico -->
            <main class="flex-1 p-4 sm:p-6 lg:p-8">
                <!-- VIEW 1: Biblioteca -->
                <div id="view-biblioteca" class="view-content"><div class="mb-6"><h2 class="text-2xl font-bold text-slate-800">Biblioteca de Procedimentos</h2><p class="text-slate-500 mt-1">Acesse treinamentos, guias e materiais de apoio.</p></div><div id="library-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div></div>
                <!-- VIEW 2: Mapa -->
                <div id="view-mapa" class="view-content hidden"><div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4"><div><h2 class="text-2xl font-bold text-slate-800">Mapa de Conhecimentos da Equipe</h2><p class="text-slate-500 mt-1">Visualize e compare o nível de domínio da sua equipe.</p></div><button id="addKnowledgeBtn" class="flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition"><i data-lucide="plus-circle" class="w-5 h-5"></i> Adicionar Registro</button></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6"><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full"><div class="flex items-center gap-4"><div class="bg-indigo-100 p-3 rounded-full flex-shrink-0"><i data-lucide="bar-chart-big" class="text-indigo-600"></i></div><p class="text-sm text-slate-500">Média Geral</p></div><div class="mt-auto pt-4"><p id="kpiAvgValue" class="text-3xl font-bold text-slate-800">0.0</p></div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full"><div class="flex items-center gap-4"><div class="bg-emerald-100 p-3 rounded-full flex-shrink-0"><i data-lucide="trending-up" class="text-emerald-600"></i></div><p class="text-sm text-slate-500">Tema mais Forte</p></div><div class="mt-auto pt-4"><p id="kpiStrongestValue" class="text-xl font-bold text-slate-800 break-words">N/A</p></div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full"><div class="flex items-center gap-4"><div class="bg-rose-100 p-3 rounded-full flex-shrink-0"><i data-lucide="trending-down" class="text-rose-600"></i></div><p class="text-sm text-slate-500">Ponto de Atenção</p></div><div class="mt-auto pt-4"><p id="kpiWeakestValue" class="text-xl font-bold text-slate-800 break-words">N/A</p></div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full"><div class="flex items-center gap-4"><div class="bg-sky-100 p-3 rounded-full flex-shrink-0"><i data-lucide="users" class="text-sky-600"></i></div><p class="text-sm text-slate-500">Colaboradores</p></div><div class="mt-auto pt-4"><p id="kpiTotalValue" class="text-3xl font-bold text-slate-800">0</p></div></div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6"><h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2 text-base"><i data-lucide="filter" class="w-5 h-5"></i> Filtros e Ações</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><div><label for="collaboratorFilter" class="block mb-1 text-sm font-medium text-slate-600">Colaborador</label><select id="collaboratorFilter" class="w-full bg-slate-50 border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 transition"></select></div><div><label for="topicFilter" class="block mb-1 text-sm font-medium text-slate-600">Tema</label><select id="topicFilter" class="w-full bg-slate-50 border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 transition"></select></div><div><label for="chartTypeSelector" class="block mb-1 text-sm font-medium text-slate-600">Gráfico</label><select id="chartTypeSelector" class="w-full bg-slate-50 border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 transition"><option value="bar">Barras</option><option value="radar">Radar</option><option value="doughnut">Rosca</option></select></div><div class="flex gap-3"><button id="exportCsvBtn" title="Exportar para CSV" class="w-full flex items-center justify-center gap-2 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i> CSV</button><button id="exportXlsxBtn" title="Exportar para Excel" class="w-full flex items-center justify-center gap-2 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i> Excel</button></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-4 sm:p-6"><h3 class="text-lg font-semibold text-slate-800 mb-4">Registros Detalhados</h3><div class="overflow-x-auto"><table class="responsive-map-table w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"></thead><tbody id="knowledgeTableBody" class="divide-y divide-slate-200 md:divide-y-0"></tbody></table></div></div><div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-slate-200 p-6"><h3 id="chartTitle" class="font-semibold text-slate-800 mb-4">Análise Visual</h3><div class="h-80"><canvas id="knowledgeChart"></canvas></div></div></div></div>
                <!-- VIEW 3: Desenvolvimento -->
                <div id="view-desenvolvimento" class="view-content hidden">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Desenvolvimento Pessoal</h2>
                            <p class="text-slate-500 mt-1">Acompanhe as trilhas de aprendizagem e conquistas de cada colaborador.</p>
                        </div>
                        <div>
                            <label for="devCollaboratorFilter" class="block mb-1 text-sm font-medium text-slate-600">Analisar Colaborador</label>
                            <select id="devCollaboratorFilter" class="w-full md:w-64 bg-white border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 transition"></select>
                        </div>
                    </div>
                    <div id="development-content-container">
                        <!-- Conteúdo será renderizado aqui -->
                    </div>
                </div>
                <!-- VIEW 4: Monitoramento -->
                <div id="view-monitoramento" class="view-content hidden">
                     <div class="mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Monitoramento de Engajamento</h2>
                        <p class="text-slate-500 mt-1">Acompanhe a evolução, participação e destaques da equipe.</p>
                    </div>
                    <div id="monitor-content">
                        <!-- Conteúdo será renderizado aqui -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Conhecimento -->
    <div id="knowledgeModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300 z-50"><div class="bg-white w-full max-w-lg p-6 rounded-xl shadow-2xl transition-transform duration-300 transform scale-95"><form id="knowledgeForm"><input type="hidden" id="editId"><h2 id="modalTitle" class="text-2xl font-bold mb-6 text-slate-900"></h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="mb-4"><label for="name" class="block mb-2 text-sm font-medium text-slate-700">Colaborador</label><input type="text" id="name" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 transition" required></div><div class="mb-4"><label for="role" class="block mb-2 text-sm font-medium text-slate-700">Cargo</label><input type="text" id="role" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 transition" required></div><div class="mb-4 md:col-span-2"><label for="topic" class="block mb-2 text-sm font-medium text-slate-700">Tema</label><input type="text" id="topic" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 transition" required></div><div class="mb-4"><label for="priority" class="block mb-2 text-sm font-medium text-slate-700">Prioridade</label><select id="priority" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 transition" required><option value="Alta">Alta</option><option value="Média">Média</option><option value="Baixa">Baixa</option></select></div><div class="mb-4"><label for="evaluationDate" class="block mb-2 text-sm font-medium text-slate-700">Avaliação</label><input type="date" id="evaluationDate" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 transition" required></div><div class="mb-6 md:col-span-2"><label for="level" class="block mb-2 text-sm font-medium text-slate-700">Nível (<span id="levelValue" class="font-bold text-indigo-600">5</span>)</label><input type="range" id="level" min="0" max="10" value="5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"></div></div><div class="flex justify-end gap-4 mt-2"><button type="button" class="btn-cancel py-2 px-4 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 transition">Cancelar</button><button type="submit" id="saveBtn" class="py-2.5 px-5 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Salvar</button></div></form></div></div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300 z-50"><div class="bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transition-transform duration-300 transform scale-95"><h2 class="text-lg font-bold text-slate-900">Confirmar Ação</h2><p class="mt-2 text-sm text-slate-600">Você tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.</p><div class="mt-6 flex justify-end gap-4"><button type="button" class="btn-cancel py-2 px-4 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 transition">Cancelar</button><button type="button" id="confirmDeleteBtn" class="py-2 px-4 bg-rose-600 text-white font-semibold rounded-lg hover:bg-rose-700 transition">Excluir</button></div></div></div>
    
    <!-- Modal Detalhes da Biblioteca -->
    <div id="libraryDetailModal" class="fixed inset-0 bg-slate-900 bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300 z-50"><div class="bg-white w-full max-w-4xl p-6 rounded-xl shadow-2xl transition-transform duration-300 transform scale-95 max-h-[90vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h2 id="libraryModalTitle" class="text-2xl font-bold text-slate-900"></h2><button class="btn-cancel text-slate-500 hover:text-slate-800">&times;</button></div><div class="flex-1 overflow-y-auto"><div class="aspect-w-16 aspect-h-9 bg-slate-200 rounded-lg mb-4 flex items-center justify-center"><i data-lucide="play-circle" class="w-16 h-16 text-slate-400"></i></div><h3 class="font-semibold text-lg mb-2">Guia Rápido</h3><p class="text-slate-600 text-sm">Este é um guia detalhado sobre o procedimento. Siga os passos abaixo para concluir o treinamento. Em breve, esta área conterá textos explicativos, passo-a-passo e um quiz interativo para validar seu conhecimento.</p></div></div></div>

    <!-- Notificação Toast -->
    <div id="toast-notification" class="bg-slate-800 text-white py-3 px-5 rounded-lg shadow-xl"><p id="toast-message"></p></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DADOS INICIAIS ---
        const loggedInUser = 'Jhonatan';
        let libraryProcedures = [
            { id: 'lp', title: 'Apuração Lucro Presumido', icon: 'landmark', color: 'indigo' },
            { id: 'sped', title: 'SPED Fiscal', icon: 'file-text', color: 'sky' },
            { id: 'fp', title: 'Folha de Pagamento', icon: 'users', color: 'rose' },
            { id: 'rf', title: 'Retenções Federais', icon: 'receipt', color: 'amber' },
        ];
        let learningPaths = [
            { id: 'onboarding', title: 'Onboarding Fiscal', description: 'Conceitos essenciais para iniciar na área fiscal.', courses: ['lp', 'rf'] },
            { id: 'analista_fiscal', title: 'Formação Analista Fiscal', description: 'Domine as principais obrigações fiscais.', courses: ['lp', 'sped', 'rf'] }
        ];
        let achievements = [
            { id: 'primeiro_treino', title: 'Primeiros Passos', icon: 'footprints', description: 'Concluiu seu primeiro treinamento.', unlocked: false },
            { id: 'especialista', title: 'Especialista', icon: 'star', description: 'Atingiu o nível máximo em um tema.', unlocked: false },
            { id: 'polivalente', title: 'Polivalente', icon: 'git-fork', description: 'Domina 3 ou mais temas.', unlocked: false },
            { id: 'mentor', title: 'Mentor', icon: 'award', description: 'É um especialista em um tema de alta prioridade.', unlocked: false },
        ];
        let userProgress = [
            { user: 'Jhonatan', procedureId: 'lp', status: 'Concluído'},
            { user: 'Jhonatan', procedureId: 'sped', status: 'Em Andamento'},
            { user: 'Maria', procedureId: 'lp', status: 'Concluído'},
            { user: 'Maria', procedureId: 'sped', status: 'Concluído'},
            { user: 'Maria', procedureId: 'fp', status: 'Em Andamento'},
            { user: 'Carlos', procedureId: 'sped', status: 'Concluído'},
            { user: 'Ana', procedureId: 'fp', status: 'Não Iniciado'},
            { user: 'João', procedureId: 'lp', status: 'Em Andamento' },
            { user: 'Ryan', procedureId: 'rf', status: 'Concluído' },
            { user: 'Ryan', procedureId: 'lp', status: 'Concluído' },
        ];
        let interactions = [
            { from: 'João', to: 'Jhonatan', subject: 'Dúvida sobre SPED', date: '2025-09-04' },
            { from: 'Ana', to: 'Maria', subject: 'Cálculo de Férias (Folha)', date: '2025-09-03' },
            { from: 'Carlos', to: 'Ryan', subject: 'Bloco K - SPED Fiscal', date: '2025-09-02' },
            { from: 'Jhonatan', to: 'Laura', subject: 'Revisão Planejamento Tributário', date: '2025-09-01' },
            { from: 'João', to: 'Jhonatan', subject: 'Cálculo Trimestral', date: '2025-08-30' },
        ];
        let knowledgeData = [
            { id: 1, name: 'Jhonatan', role: 'Analista Fiscal Sênior', topic: 'Apuração Lucro Presumido', level: 10, priority: 'Alta', evaluationDate: '2025-08-20', trainingHours: 15 },
            { id: 2, name: 'Ryan', role: 'Analista Fiscal Pleno', topic: 'Apuração Lucro Presumido', level: 8, priority: 'Alta', evaluationDate: '2025-08-20', trainingHours: 12 },
            { id: 3, name: 'João', role: 'Estagiário Fiscal', topic: 'Apuração Lucro Presumido', level: 3, priority: 'Média', evaluationDate: '2025-09-01', trainingHours: 5 },
            { id: 4, name: 'Maria', role: 'Contadora Sênior', topic: 'SPED Fiscal', level: 9, priority: 'Alta', evaluationDate: '2025-08-18', trainingHours: 20 },
            { id: 5, name: 'Carlos', role: 'Analista Fiscal Jr', topic: 'SPED Fiscal', level: 6, priority: 'Alta', evaluationDate: '2025-08-28', trainingHours: 8 },
            { id: 6, name: 'Ana', role: 'Estagiária Contábil', topic: 'Folha de Pagamento', level: 4, priority: 'Média', evaluationDate: '2025-09-02', trainingHours: 10 },
            { id: 7, name: 'Jhonatan', role: 'Analista Fiscal Sênior', topic: 'Folha de Pagamento', level: 7, priority: 'Baixa', evaluationDate: '2025-08-20', trainingHours: 6 },
            { id: 8, name: 'Laura', role: 'Gerente Contábil', topic: 'Planejamento Tributário', level: 10, priority: 'Alta', evaluationDate: '2025-08-21', trainingHours: 25 },
            { id: 9, name: 'Pedro', role: 'Analista Contábil Pleno', topic: 'Planejamento Tributário', level: 7, priority: 'Alta', evaluationDate: '2025-08-25', trainingHours: 11 },
            { id: 10, name: 'Ryan', role: 'Analista Fiscal Pleno', topic: 'Retenções Federais', level: 7, priority: 'Média', evaluationDate: '2025-08-17', trainingHours: 16 },
            { id: 11, name: 'Maria', role: 'Contadora Sênior', topic: 'Folha de Pagamento', level: 8, priority: 'Média', evaluationDate: '2025-08-18', trainingHours: 14 },
        ];
        
        // --- ELEMENTOS GLOBAIS ---
        const modals = document.querySelectorAll('.fixed.inset-0');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');

        // --- LÓGICA DE NAVEGAÇÃO E INICIALIZAÇÃO ---
        let isMapInitialized = false, isMonitoringInitialized = false, isDevInitialized = false;
        const switchView = (viewId) => {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            sidebarLinks.forEach(l => l.classList.toggle('active', l.dataset.view === viewId));
            if (window.innerWidth < 1024) document.getElementById('sidebar').classList.add('-translate-x-full');

            if (viewId === 'mapa' && !isMapInitialized) { initMapModule(); isMapInitialized = true; }
            if (viewId === 'desenvolvimento' && !isDevInitialized) { initDevelopmentModule(); isDevInitialized = true; }
            if (viewId === 'monitoramento' && !isMonitoringInitialized) { initMonitoringModule(); isMonitoringInitialized = true; }
        };
        
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.currentTarget.dataset.view);
            });
        });

        const openModal = (modal) => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.transform').classList.remove('scale-95');
            }, 10);
        };
        const closeModal = (modal) => {
            modal.classList.add('opacity-0');
            modal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        
        modals.forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal || e.target.closest('.btn-cancel')) {
                    closeModal(modal);
                }
            });
        });

        // --- MÓDULO: BIBLIOTECA ---
        const libraryGrid = document.getElementById('library-grid');
        const libraryDetailModal = document.getElementById('libraryDetailModal');
        const renderLibrary = () => {
            const loggedInUserProgress = userProgress.filter(p => p.user === loggedInUser);
            const statusStyles = {'Concluído': 'text-emerald-800 bg-emerald-100','Em Andamento': 'text-amber-800 bg-amber-100','Não Iniciado': 'text-slate-800 bg-slate-200'};
            const colorStyles = { 'indigo': 'bg-indigo-100 text-indigo-600', 'sky': 'bg-sky-100 text-sky-600', 'rose': 'bg-rose-100 text-rose-600', 'amber': 'bg-amber-100 text-amber-600' };
            
            libraryGrid.innerHTML = libraryProcedures.map(p => {
                const progress = loggedInUserProgress.find(item => item.procedureId === p.id);
                const status = progress ? progress.status : 'Não Iniciado';
                return `
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:-translate-y-1 transition-all duration-300 cursor-pointer library-card" data-title="${p.title}">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="p-3 rounded-lg ${colorStyles[p.color]}"><i data-lucide="${p.icon}"></i></div>
                        <h3 class="font-semibold text-slate-800">${p.title}</h3>
                    </div>
                    <div class="flex items-center justify-between text-xs"><span class="font-semibold text-slate-600">Seu Progresso:</span><span class="px-2 py-1 font-semibold rounded-full ${statusStyles[status]}">${status}</span></div>
                </div>`
            }).join('');
            lucide.createIcons();
        };
        libraryGrid.addEventListener('click', e => {
            const card = e.target.closest('.library-card');
            if(card) {
                document.getElementById('libraryModalTitle').textContent = card.dataset.title;
                openModal(libraryDetailModal);
            }
        });

        // --- MÓDULO: MAPA DE CONHECIMENTOS ---
        let knowledgeChart = null;
        let currentFilters = { collaborator: 'all', topic: 'all', chartType: 'bar' };
        const knowledgeModal = document.getElementById('knowledgeModal'), knowledgeForm = document.getElementById('knowledgeForm');
        const confirmModal = document.getElementById('confirmModal');
        let deleteId = null;

        const getLevelDisplay = (level) => {
            const colors = level >= 8 ? 'bg-emerald-500' : level >= 5 ? 'bg-amber-500' : 'bg-rose-500';
            return `
                <div class="flex items-center gap-3">
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div class="${colors}" style="width: ${level * 10}%"></div>
                    </div>
                    <span class="font-bold text-sm text-slate-700 w-6 text-right">${level}</span>
                </div>
            `;
        };

        const renderTable = (data) => {
            const tbody = document.getElementById('knowledgeTableBody'), thead = tbody.previousElementSibling;
            thead.innerHTML = `<tr><th class="px-6 py-3">Colaborador</th><th class="px-6 py-3">Tema</th><th class="px-6 py-3 w-48">Nível</th><th class="px-6 py-3">Ações</th></tr>`;
            tbody.innerHTML = data.length ? data.map(item => {
                let actions = `
                    <button class="edit-btn p-1 text-indigo-600 hover:text-indigo-800 transition" data-id="${item.id}" title="Editar"><i data-lucide="edit-3" class="w-5 h-5"></i></button>
                    <button class="delete-btn p-1 text-rose-600 hover:text-rose-800 transition" data-id="${item.id}" title="Excluir"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                `;
                if(item.level >= 9 && item.name !== loggedInUser) {
                     actions += `<button class="contact-expert-btn p-1 text-sky-600 hover:text-sky-800 transition" data-name="${item.name}" data-topic="${item.topic}" title="Contatar Especialista"><i data-lucide="message-circle" class="w-5 h-5"></i></button>`;
                }
                return `
                <tr>
                    <td class="px-6 py-4" data-label="Colaborador"><div class="font-medium text-slate-900">${item.name}</div><div class="text-xs text-slate-500">${item.role}</div></td>
                    <td class="px-6 py-4" data-label="Tema">${item.topic}</td>
                    <td class="px-6 py-4" data-label="Nível">${getLevelDisplay(item.level)}</td>
                    <td class="px-6 py-4" data-label="Ações"><div class="flex gap-3 justify-end md:justify-start">${actions}</div></td>
                </tr>`}).join('') : `<tr><td colspan="4" class="text-center p-8 text-slate-500">Nenhum registro encontrado.</td></tr>`;
            lucide.createIcons();
        };

        const updateKpiCards = (data) => {
            document.getElementById('kpiAvgValue').textContent = data.length ? (data.reduce((s, i) => s + i.level, 0) / data.length).toFixed(1) : '0.0';
            document.getElementById('kpiTotalValue').textContent = [...new Set(data.map(i => i.name))].length;
            if (data.length) {
                const topics = data.reduce((a, i) => ({...a, [i.topic]: {s:(a[i.topic]?.s||0)+i.level, c:(a[i.topic]?.c||0)+1}}), {});
                const topicAvgs = Object.entries(topics).map(([t, {s, c}]) => ({topic: t, avg: s/c}));
                document.getElementById('kpiStrongestValue').textContent = topicAvgs.reduce((a, b) => a.avg > b.avg ? a : b).topic;
                document.getElementById('kpiWeakestValue').textContent = topicAvgs.reduce((a, b) => a.avg < b.avg ? a : b).topic;
            } else { ['kpiStrongestValue', 'kpiWeakestValue'].forEach(id => document.getElementById(id).textContent = 'N/A'); }
        };

        const updateChart = (data, type) => {
            const ctx = document.getElementById('knowledgeChart').getContext('2d');
            if (knowledgeChart) knowledgeChart.destroy();
            if (!ctx || !data.length) return;
            const isCollabView = currentFilters.collaborator !== 'all';
            document.getElementById('chartTitle').textContent = isCollabView ? `Desempenho de ${currentFilters.collaborator}` : `Comparativo por Tema: ${currentFilters.topic === 'all' ? 'Geral' : currentFilters.topic}`;
            knowledgeChart = new Chart(ctx, { type,
                data: { labels: data.map(i => isCollabView ? i.topic : i.name), datasets: [{ label: 'Nível', data: data.map(i => i.level), backgroundColor: 'rgba(79, 70, 229, 0.7)', borderColor: 'rgba(79, 70, 229, 1)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: type!=='radar'?{y:{beginAtZero:true, max:10}}:{r:{beginAtZero:true, max:10}}, plugins: { legend: { display: false } } }
            });
        };
        
        const populateFilters = (selectId, dataKey) => {
            const selectEl = document.getElementById(selectId);
            if (!selectEl) return;
            let items = [...new Set(knowledgeData.map(i => i[dataKey]).sort())];
            if (selectId.includes('Filter')) {
                items.unshift('Todos');
                if (selectId === 'monitorCollaboratorFilter') items[0] = 'Visão Geral da Equipe';
                if (selectId === 'devCollaboratorFilter') items[0] = 'Selecione um colaborador';
            }
            
            selectEl.innerHTML = items.map((i, index) => {
                let value = i;
                if(index === 0 && (selectId.includes('Filter'))) value = 'all';
                let disabled = selectId === 'devCollaboratorFilter' && index === 0 ? 'disabled selected' : '';
                return `<option value="${value}" ${disabled}>${i}</option>`
            }).join('');
        };

        const applyFiltersAndRender = () => {
            let data = knowledgeData.filter(i => (currentFilters.collaborator==='all' || i.name===currentFilters.collaborator) && (currentFilters.topic==='all' || i.topic===currentFilters.topic));
            renderTable(data); updateKpiCards(data); updateChart(data, currentFilters.chartType);
        };
        
        const handleFormSubmit = (e) => {
            e.preventDefault();
            const id = parseInt(knowledgeForm.querySelector('#editId').value);
            const record = { 
                name: knowledgeForm.elements.name.value, 
                role: knowledgeForm.elements.role.value, 
                topic: knowledgeForm.elements.topic.value, 
                level: parseInt(knowledgeForm.elements.level.value), 
                priority: knowledgeForm.elements.priority.value, 
                evaluationDate: knowledgeForm.elements.evaluationDate.value 
            };
            if (id) {
                knowledgeData = knowledgeData.map(i => i.id === id ? { ...i, ...record } : i);
                showToast('Registro atualizado com sucesso!');
            } else {
                knowledgeData.push({ ...record, id: Date.now(), trainingHours: Math.floor(Math.random() * 10) + 1 });
                showToast('Novo registro adicionado!');
            }
            closeModal(knowledgeModal);
            ['collaboratorFilter', 'topicFilter', 'devCollaboratorFilter', 'monitorCollaboratorFilter'].forEach(id => populateFilters(id, 'name'));
            applyFiltersAndRender();
        };

        const initMapModule = () => {
            populateFilters('collaboratorFilter', 'name');
            populateFilters('topicFilter', 'topic');
            applyFiltersAndRender();
            document.getElementById('addKnowledgeBtn').addEventListener('click', () => {
                knowledgeForm.reset(); document.getElementById('editId').value = '';
                document.getElementById('modalTitle').textContent = 'Adicionar Novo Registro';
                document.getElementById('levelValue').textContent = 5;
                knowledgeForm.elements.evaluationDate.value = new Date().toISOString().split('T')[0];
                openModal(knowledgeModal);
            });
            document.getElementById('knowledgeTableBody').addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn'), deleteBtn = e.target.closest('.delete-btn'), contactBtn = e.target.closest('.contact-expert-btn');
                if (editBtn) {
                    const item = knowledgeData.find(i => i.id === parseInt(editBtn.dataset.id));
                    Object.keys(item).forEach(k => { if(knowledgeForm.elements[k]) knowledgeForm.elements[k].value = item[k]; });
                    document.getElementById('editId').value = item.id;
                    document.getElementById('levelValue').textContent = item.level;
                    document.getElementById('modalTitle').textContent = 'Editar Registro';
                    openModal(knowledgeModal);
                }
                if (deleteBtn) { deleteId = parseInt(deleteBtn.dataset.id); openModal(confirmModal); }
                if (contactBtn) showToast(`Dúvida sobre ${contactBtn.dataset.topic} enviada para ${contactBtn.dataset.name}!`);
            });
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                knowledgeData = knowledgeData.filter(i => i.id !== deleteId);
                closeModal(confirmModal); showToast('Registro excluído com sucesso!');
                populateFilters('collaboratorFilter', 'name');
                populateFilters('topicFilter', 'topic');
                applyFiltersAndRender();
            });
            knowledgeForm.addEventListener('submit', handleFormSubmit);
            knowledgeForm.querySelector('#level').addEventListener('input', e => document.getElementById('levelValue').textContent = e.target.value);
            
            ['collaboratorFilter', 'topicFilter', 'chartTypeSelector'].forEach(id => {
                document.getElementById(id).addEventListener('change', e => {
                    const key = id.includes('collab') ? 'collaborator' : id.includes('topic') ? 'topic' : 'chartType';
                    currentFilters[key] = e.target.value;
                    if (key === 'collaborator' && e.target.value !== 'all') {
                        document.getElementById('chartTypeSelector').value = 'radar';
                        currentFilters.chartType = 'radar';
                    }
                    applyFiltersAndRender();
                });
            });
            ['exportCsvBtn', 'exportXlsxBtn'].forEach(id => {
                document.getElementById(id).addEventListener('click', () => {
                    const data = knowledgeData.filter(i => (currentFilters.collaborator==='all' || i.name===currentFilters.collaborator) && (currentFilters.topic==='all' || i.topic===currentFilters.topic));
                    if(!data.length){ showToast("Não há dados para exportar."); return; }
                    const worksheet = XLSX.utils.json_to_sheet(data);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Conhecimentos");
                    XLSX.writeFile(workbook, `KnowMap_Export_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.${id.includes('Csv') ? 'csv':'xlsx'}`);
                });
            });
        };

        // --- MÓDULO: DESENVOLVIMENTO ---
        const renderDevelopmentView = (collaboratorName) => {
            const container = document.getElementById('development-content-container');
            if (!collaboratorName || collaboratorName === 'all') {
                container.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-sm border border-slate-200"><i data-lucide="user-check" class="mx-auto w-12 h-12 text-indigo-400"></i><p class="mt-4 font-semibold text-slate-700">Selecione um colaborador</p><p class="text-sm text-slate-500">Escolha um membro da equipe no menu acima para ver seus detalhes de desenvolvimento.</p></div>`;
                lucide.createIcons();
                return;
            }

            const userKnw = knowledgeData.filter(i => i.name === collaboratorName);
            const userPrg = userProgress.filter(p => p.user === collaboratorName);

            achievements.forEach(a => a.unlocked = false);
            achievements.find(a => a.id === 'primeiro_treino').unlocked = userPrg.some(p => p.status === 'Concluído');
            achievements.find(a => a.id === 'especialista').unlocked = userKnw.some(k => k.level === 10);
            achievements.find(a => a.id === 'polivalente').unlocked = [...new Set(userKnw.map(k => k.topic))].length >= 3;
            achievements.find(a => a.id === 'mentor').unlocked = userKnw.some(k => k.level >= 9 && k.priority === 'Alta');

            const pathsHTML = learningPaths.map(path => {
                const coursesInPath = path.courses;
                const completedCourses = userPrg.filter(p => coursesInPath.includes(p.procedureId) && p.status === 'Concluído').length;
                const progress = coursesInPath.length > 0 ? (completedCourses / coursesInPath.length) * 100 : 0;
                return `
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h4 class="font-bold text-lg text-slate-800">${path.title}</h4>
                    <p class="text-sm text-slate-500 mt-1 mb-4">${path.description}</p>
                    <div class="w-full bg-slate-200 rounded-full h-2.5 mb-2">
                        <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                    <p class="text-xs text-slate-500 text-right">${Math.round(progress)}% concluído</p>
                </div>`;
            }).join('');

            const achievementsHTML = achievements.map(ach => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center ${!ach.unlocked ? 'opacity-50' : ''}">
                    <div class="w-16 h-16 rounded-full mx-auto flex items-center justify-center ${ach.unlocked ? 'bg-amber-100' : 'bg-slate-100'}">
                        <i data-lucide="${ach.icon}" class="${ach.unlocked ? 'text-amber-500' : 'text-slate-400'}"></i>
                    </div>
                    <p class="font-semibold text-sm mt-3 text-slate-700">${ach.title}</p>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-slate-800 mb-4">Trilhas de Aprendizagem de ${collaboratorName}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">${pathsHTML}</div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold text-slate-800 mb-4">Conquistas de ${collaboratorName}</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">${achievementsHTML}</div>
                </div>`;
            lucide.createIcons();
        };

        const initDevelopmentModule = () => {
            const filterEl = document.getElementById('devCollaboratorFilter');
            populateFilters('devCollaboratorFilter', 'name');
            filterEl.addEventListener('change', (e) => {
                renderDevelopmentView(e.target.value);
            });
            renderDevelopmentView('all');
        };

        // --- MÓDULO: MONITORAMENTO ---
        const renderMonitoringView = (filterTerm = '') => {
            const dataToUse = filterTerm 
                ? knowledgeData.filter(i => i.name.toLowerCase().includes(filterTerm))
                : knowledgeData;

            const progressToUse = filterTerm
                ? userProgress.filter(p => p.user.toLowerCase().includes(filterTerm))
                : userProgress;

            const totalHours = dataToUse.reduce((sum, item) => sum + (item.trainingHours || 0), 0);
            const completedCount = progressToUse.filter(item => item.status === 'Concluído').length;
            
            const scores = dataToUse.reduce((acc, item) => {
                acc[item.name] = (acc[item.name] || 0) + item.level;
                return acc;
            }, {});
            const ranked = Object.entries(scores).sort(([,a],[,b]) => b - a);

            const container = document.getElementById('monitor-content');
            container.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-sm text-slate-500 mb-2">Tempo total em treinamento</p><p class="text-3xl font-bold text-slate-800">${totalHours} <span class="text-lg font-medium text-slate-500">horas</span></p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-sm text-slate-500 mb-2">Treinamentos Concluídos</p><p class="text-3xl font-bold text-slate-800">${completedCount}</p></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><p class="text-sm text-slate-500 mb-2">Colaborador Destaque</p><p class="text-xl font-bold text-slate-800">${ranked.length > 0 ? ranked[0][0] : 'N/A'}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-semibold text-slate-800 mb-4">Evolução de Engajamento (Equipe)</h3>
                        <div class="h-80"><canvas id="engagementChart"></canvas></div>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="font-semibold text-slate-800 mb-4">Ranking de Colaboradores</h3>
                        <div id="ranking-list" class="overflow-y-auto h-80"></div>
                    </div>
                </div>`;
            
            const rankingListEl = document.getElementById('ranking-list');
            if(ranked.length > 0) {
                 rankingListEl.innerHTML = ranked.map(([name, score], i) => `
                    <div class="flex items-center justify-between py-3 ${i < ranked.length - 1 ? 'border-b border-slate-100' : ''}">
                        <div class="flex items-center gap-3"><span class="font-bold text-sm w-5 text-center">${i+1}</span><span class="font-medium text-slate-700">${name}</span></div>
                        <span class="font-bold text-indigo-600">${score} pts</span>
                    </div>`).join('');
            } else {
                rankingListEl.innerHTML = `<p class="text-center p-8 text-slate-500">Nenhum colaborador encontrado.</p>`;
            }

            const chartCtx = document.getElementById('engagementChart').getContext('2d');
            new Chart(chartCtx, { type: 'line', data: { labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'], datasets: [{ label: 'Horas de Treinamento', data: [45, 59, 80, 81], borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } });
        };
        
        const initMonitoringModule = () => {
             renderMonitoringView();
        };

        // --- FUNÇÕES GLOBAIS ---
        const showToast = (message) => {
            const toast = document.getElementById('toast-notification'), msgEl = document.getElementById('toast-message');
            msgEl.textContent = message; toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        
        document.getElementById('globalSearchInput').addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            const activeView = document.querySelector('.view-content:not(.hidden)').id;
            if (activeView === 'view-mapa') {
                const data = knowledgeData.filter(i => Object.values(i).some(v => String(v).toLowerCase().includes(term)));
                renderTable(data);
            } else if (activeView === 'view-monitoramento') {
                renderMonitoringView(term);
            } else if (activeView === 'view-biblioteca') {
                 document.querySelectorAll('.library-card').forEach(card => card.style.display = card.dataset.title.toLowerCase().includes(term) ? '' : 'none');
            }
        });

        // --- INICIALIZAÇÃO ---
        document.getElementById('loggedInUserName').textContent = loggedInUser;
        renderLibrary();
        switchView('biblioteca');
        document.getElementById('menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
    });
    </script>
</body>
</html>

